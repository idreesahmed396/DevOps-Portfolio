name: CI/CD Portfolio

on:
  push:
    branches: [main]       # Run when you push to main
  pull_request:
    branches: [main]       # Run for pull requests
  workflow_dispatch:       # Optional: allows manual trigger

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout your repository
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Log in to Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 3. Set image tag based on Git SHA
      - name: Set image tag
        id: vars
        run: echo "IMAGE_TAG=${GITHUB_SHA::8}" >> $GITHUB_ENV

      # 4. Build Docker image with unique tag
      - name: Build Docker image
        run: |
          docker build -t idreesahmed396/devops-portfolio:${{ env.IMAGE_TAG }} .
          docker push idreesahmed396/devops-portfolio:${{ env.IMAGE_TAG }}

      # 5. Install kubectl
      - name: Install kubectl
        run: sudo snap install kubectl --classic

      # 6. Set up kubeconfig for K3S cluster
      - name: Set kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.K3S_KUBECONFIG }}" > ~/.kube/config

      # 7. Update deployment with new image
      - name: Update portfolio deployment
        run: |
          kubectl set image deployment/portfolio \
            portfolio=idreesahmed396/devops-portfolio:${{ env.IMAGE_TAG }} -n default
          kubectl rollout status deployment/portfolio -n default

      # 8. Optional: Cleanup old Docker images on Docker Hub (keep last 5)
      - name: Cleanup old Docker images (optional)
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
          TAGS=$(curl -s -u $DOCKER_USERNAME:$DOCKER_PASSWORD \
            "https://hub.docker.com/v2/repositories/$DOCKER_USERNAME/devops-portfolio/tags?page_size=100" \
            | jq -r '.results | sort_by(.last_updated) | .[].name')
          COUNT=0
          TAG_ARRAY=($TAGS)
          TOTAL=${#TAG_ARRAY[@]}
          for TAG in "${TAG_ARRAY[@]}"; do
            COUNT=$((COUNT+1))
            if [ $COUNT -le $((TOTAL-5)) ]; then
              echo "Deleting old image tag: $TAG"
              curl -s -X DELETE -u $DOCKER_USERNAME:$DOCKER_PASSWORD \
                "https://hub.docker.com/v2/repositories/$DOCKER_USERNAME/devops-portfolio/tags/$TAG/"
            fi
          done || true
